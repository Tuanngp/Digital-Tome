<!DOCTYPE html>
<html lang="en">
<head th:replace="~{layout/head :: head}"><title>Home</title></head>
<body>
<div class="page-wraper">
    <div class="preloader-wrapper-1" id="loading-area">
        <div class="preloader-inner">
            <div class="preloader-shade"></div>
            <div class="preloader-wrap"></div>
            <div class="preloader-wrap wrap2"></div>
            <div class="preloader-wrap wrap3"></div>
            <div class="preloader-wrap wrap4"></div>
            <div class="preloader-wrap wrap5"></div>
        </div>
    </div>

    <!-- Bootstrap Spinner -->
    <div id="loading-spinner" class="text-center" style="display: none;">
        <div class="spinner-border" role="status">
            <span class="sr-only">Loading...</span>
        </div>
    </div>

    <!-- Header -->
    <header th:replace="~{layout/header :: header}"></header>
    <!-- Header End -->
    <div class="page-content bg-grey">
        <div class="content-inner-1 border-bottom">
            <div class="container">
                <div class="row ">
                    <div class="col-xl-3">
                        <div class="shop-filter">
                            <div class="d-flex justify-content-between">
                                <h4 class="title">Filter Option</h4>
                                <a class="panel-close-btn" href="javascript:void(0);"><i class="flaticon-close"></i></a>
                            </div>
                            <div class="accordion accordion-filter" id="accordionExample">
                                <div class="accordion-item">
                                    <button aria-controls="collapseFive" aria-expanded="false" class="accordion-button"
                                            data-bs-target="#collapseFive" data-bs-toggle="collapse"
                                            id="headingFive" type="button">
                                        Point Range
                                    </button>
                                    <div aria-labelledby="headingFive" class="accordion-collapse collapse accordion-body show"
                                         data-bs-parent="#accordionExample" id="collapseFive">
                                        <input id="minPoint" type="number" min="0" step="1" placeholder="min point"/>
                                        <input id="maxPoint" type="number" min="0" step="1" placeholder="max point"/>
                                    </div>
                                </div>
                                <div class="accordion-item">
                                    <button aria-controls="collapseOne" aria-expanded="true" class="accordion-button"
                                            data-bs-target="#collapseOne" data-bs-toggle="collapse" id="headingOne"
                                            type="button">Category
                                    </button>
                                    <div aria-labelledby="headingOne" class="accordion-collapse collapse show accordion-body"
                                         data-bs-parent="#accordionExample" id="collapseOne">
                                        <div class="widget dz-widget_services d-flex justify-content-between">
                                            <div class="">
                                                <div class="form-check search-content" th:each="category : ${categories}">
                                                        <input class="form-check-input" th:id="'categoryCheckBox-'+${category.getId()}" type="checkbox"
                                                               th:value="${category.getName()}">
                                                    <label class="form-check-label" th:for="'categoryCheckBox-'+${category.getId()}" th:text="${category.getName()}"></label>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="accordion-item">
                                    <button aria-controls="collapseThree" aria-expanded="false" class="accordion-button collapsed"
                                            data-bs-target="#collapseThree" data-bs-toggle="collapse"
                                            id="headingThree" type="button">
                                        Select Year
                                    </button>
                                    <div aria-labelledby="headingThree" class="accordion-collapse collapse accordion-body"
                                         data-bs-parent="#accordionExample" id="collapseThree">
                                        <div class="widget dz-widget_services col d-flex justify-content-between">
                                            <div class="">
                                                <div class="form-check search-content" th:each="year : ${years}">
                                                    <input class="form-check-input" th:id="'yearCheckBox'+${year}" type="checkbox"
                                                           th:value="${year}">
                                                    <label class="form-check-label" th:for="'yearCheckBox'+${year}" th:text="${year}"></label>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="row filter-buttons">
                                <div>
                                    <button style="width: 100%" id="refineBtn" class="btn btn-secondary mt-4 btnhover d-block">Refine
                                        Search</button>
                                    <button style="width: 100%" class="btn btn-outline-secondary btnhover mt-3 d-block">Reset Filter</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-xl-9">
                        <div class="d-flex justify-content-between align-items-center">
                            <h4 class="title">Books</h4>
                        </div>
                        <div class="filter-area m-b30">
                            <div class="grid-area">
                                <div class="shop-tab">
                                    <ul class="nav text-center product-filter justify-content-end" role="tablist">
                                        <li class="nav-item">
                                            <a class="nav-link" th:href="@{/books-grid-view}">
                                                <svg fill="none" height="24" viewBox="0 0 24 24" width="24"
                                                     xmlns="http://www.w3.org/2000/svg">
                                                    <path d="M3 11H10C10.2652 11 10.5196 10.8946 10.7071 10.7071C10.8946 10.5196 11 10.2652 11 10V3C11 2.73478 10.8946 2.48043 10.7071 2.29289C10.5196 2.10536 10.2652 2 10 2H3C2.73478 2 2.48043 2.10536 2.29289 2.29289C2.10536 2.48043 2 2.73478 2 3V10C2 10.2652 2.10536 10.5196 2.29289 10.7071C2.48043 10.8946 2.73478 11 3 11ZM4 4H9V9H4V4Z"
                                                          fill="#AAAAAA"></path>
                                                    <path d="M14 11H21C21.2652 11 21.5196 10.8946 21.7071 10.7071C21.8946 10.5196 22 10.2652 22 10V3C22 2.73478 21.8946 2.48043 21.7071 2.29289C21.5196 2.10536 21.2652 2 21 2H14C13.7348 2 13.4804 2.10536 13.2929 2.29289C13.1054 2.48043 13 2.73478 13 3V10C13 10.2652 13.1054 10.5196 13.2929 10.7071C13.4804 10.8946 13.7348 11 14 11ZM15 4H20V9H15V4Z"
                                                          fill="#AAAAAA"></path>
                                                    <path d="M3 22H10C10.2652 22 10.5196 21.8946 10.7071 21.7071C10.8946 21.5196 11 21.2652 11 21V14C11 13.7348 10.8946 13.4804 10.7071 13.2929C10.5196 13.1054 10.2652 13 10 13H3C2.73478 13 2.48043 13.1054 2.29289 13.2929C2.10536 13.4804 2 13.7348 2 14V21C2 21.2652 2.10536 21.5196 2.29289 21.7071C2.48043 21.8946 2.73478 22 3 22ZM4 15H9V20H4V15Z"
                                                          fill="#AAAAAA"></path>
                                                    <path d="M14 22H21C21.2652 22 21.5196 21.8946 21.7071 21.7071C21.8946 21.5196 22 21.2652 22 21V14C22 13.7348 21.8946 13.4804 21.7071 13.2929C21.5196 13.1054 21.2652 13 21 13H14C13.7348 13 13.4804 13.1054 13.2929 13.2929C13.1054 13.4804 13 13.7348 13 14V21C13 21.2652 13.1054 21.5196 13.2929 21.7071C13.4804 21.8946 13.7348 22 14 22ZM15 15H20V20H15V15Z"
                                                          fill="#AAAAAA"></path>
                                                </svg>
                                            </a>
                                        </li>

                                    </ul>
                                </div>
                            </div>
                            <div class="category">
                                <div class="filter-category">
                                    <i class="fas fa-list me-2"></i>
                                    <select id="sortBy" class="default-select">
                                        <option value="point">Point</option>
                                        <option value="publicationDate">Date</option>
                                        <option value="title">Title</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <i class="fas fa-sort-amount-down me-2 text-secondary"></i>
                                    <select id="sortDir" class="default-select">
                                        <option value="asc">Up</option>
                                        <option value="desc">Down</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="acod-content collapse" id="collapseExample">
                            <div class="widget widget_services style-2">
                                <div class="form-check search-content">
                                    <input class="form-check-input" id="productCheckBox-25" type="checkbox" value="">
                                    <label class="form-check-label" for="productCheckBox-25">
                                        Mathematics
                                    </label>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-12 col-sm-12" id="booksList">
                        </div>
                        <div class="row page">
                            <div class="col-md-12">
                                <nav aria-label="Blog Pagination">
                                    <ul id="pagination" class="pagination style-1 p-t20"></ul>
                                </nav>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Client Start-->
        <div class="bg-white py-5">
            <div class="container">
                <!--Client Swiper -->
                <div class="swiper client-swiper">
                    <div class="swiper-wrapper">
                        <div class="swiper-slide"><img alt="client" th:src="@{../user/images/client/client1.svg}"></div>
                        <div class="swiper-slide"><img alt="client" th:src="@{../user/images/client/client2.svg}"></div>
                        <div class="swiper-slide"><img alt="client" th:src="@{../user/images/client/client3.svg}"></div>
                        <div class="swiper-slide"><img alt="client" th:src="@{../user/images/client/client4.svg}"></div>
                        <div class="swiper-slide"><img alt="client" th:src="@{../user/images/client/client5.svg}"></div>
                    </div>
                </div>
            </div>
        </div>
        <!-- Client End-->

        <!-- Feature Box -->
        <section class="content-inner">
            <div class="container">
                <div class="row sp15">
                    <div class="col-lg-3 col-md-6 col-sm-6 col-6">
                        <div class="icon-bx-wraper style-2 m-b30 text-center">
                            <div class="icon-bx-lg">
                                <i class="fa-solid fa-users icon-cell"></i>
                            </div>
                            <div class="icon-content">
                                <h2 class="dz-title counter m-b0">125,663</h2>
                                <p class="font-20">Happy Customers</p>
                            </div>
                        </div>
                    </div>
                    <div class=" col-lg-3 col-md-6 col-sm-6 col-6">
                        <div class="icon-bx-wraper style-2 m-b30 text-center">
                            <div class="icon-bx-lg">
                                <i class="fa-solid fa-book icon-cell"></i>
                            </div>
                            <div class="icon-content">
                                <h2 class="dz-title counter m-b0">50,672</h2>
                                <p class="font-20">Book Collections</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-6 col-sm-6 col-6">
                        <div class="icon-bx-wraper style-2 m-b30 text-center">
                            <div class="icon-bx-lg">
                                <i class="fa-solid fa-store icon-cell"></i>
                            </div>
                            <div class="icon-content">
                                <h2 class="dz-title counter m-b0">1,562</h2>
                                <p class="font-20">Our Stores</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-6 col-sm-6 col-6">
                        <div class="icon-bx-wraper style-2 m-b30 text-center">
                            <div class="icon-bx-lg">
                                <i class="fa-solid fa-leaf icon-cell"></i>
                            </div>
                            <div class="icon-content">
                                <h2 class="dz-title counter m-b0">457</h2>
                                <p class="font-20">Famous Writers</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
        <!-- Feature Box End -->

        <!-- Newsletter -->
        <section class="py-5 newsletter-wrapper"
                 style="background-image: url('static/user/images/background/bg1.jpg'); background-size: cover;">
            <div class="container">
                <div class="subscride-inner">
                    <div class="row style-1 justify-content-xl-between justify-content-lg-center align-items-center text-xl-start text-center">
                        <div class="col-xl-7 col-lg-12">
                            <div class="section-head mb-0">
                                <h2 class="title text-white my-lg-3 mt-0">Subscribe our newsletter for newest books
                                    updates</h2>
                            </div>
                        </div>
                        <div class="col-xl-5 col-lg-6">
                            <form action="https://bookland.dexignzone.com/xhtml/script/mailchamp.php"
                                  class="dzSubscribe style-1" method="post">
                                <div class="dzSubscribeMsg"></div>
                                <div class="form-group">
                                    <div class="input-group mb-0">
                                        <input class="form-control bg-transparent text-white" name="dzEmail" placeholder="Your Email Address"
                                               required="required"
                                               type="email">
                                        <div class="input-group-addon">
                                            <button class="btn btn-primary btnhover" name="submit" type="submit"
                                                    value="Submit">
                                                <span>SUBSCRIBE</span>
                                                <i class="fa-solid fa-paper-plane"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </section>
        <!-- Newsletter End -->

    </div>

    <div class="modal fade" id="loginModal" tabindex="-1" aria-labelledby="loginModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="loginModalLabel">Thông báo</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    Vui lòng đăng nhập để sử dụng chức năng.
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                    <a href="/login" class="btn btn-primary">Đăng nhập</a>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer th:replace="~{layout/footer :: footer}"></footer>
    <!-- Footer End -->

    <button class="scroltop" type="button"><i class="fas fa-arrow-up"></i></button>
</div>

<script th:src="@{../pagination/jquery.twbsPagination.js}" type="text/javascript"></script>
<script type="text/javascript">
    $(document).ready(function() {
        let currentPage = 1;
        let isLoading = false;
        let limit = 5;

        function collectData(page) {
            // Collect data from the 'Point Range' section
            const minPoint = $('#minPoint').val();
            const maxPoint = $('#maxPoint').val();
            const keyword = $('#keyword').val();
            const size = limit;
            var sortByValue = $('#sortBy').val();
            var sortDirValue = $('#sortDir').val();

            // Collect data from the 'Category' section
            const categories = [];
            $('#collapseOne input[type="checkbox"]:checked').each(function() {
                categories.push($(this).next('label').text().trim());
            });

            // Collect data from the 'Select Year' section
            const years = [];
            $('#collapseThree input[type="checkbox"]:checked').each(function() {
                years.push($(this).next('label').text().trim());
            });

            // Combine all data into an object
            const data = {
                keyword: keyword,
                minPoint: minPoint,
                maxPoint: maxPoint,
                categories: categories,
                years: years,
                page: page,
                size: size,
                sortByValue:sortByValue,
                sortDirValue:sortDirValue
            };

            return data;
        }

        // Function to format date as "dd-MM-yyyy"
        function formatDate(date) {
            const d = new Date(date);
            const day = ('0' + d.getDate()).slice(-2);
            const month = ('0' + (d.getMonth() + 1)).slice(-2);
            const year = d.getFullYear();
            return `${day}-${month}-${year}`;
        }

        // Function to load books and pagination
        function loadBooks(page) {
            console.log("Loading books for page", page);
            if (isLoading) return;
            isLoading = true;

            const data = collectData(page);
            $('#loading-spinner').show();
            $.ajax({
                url: '/api/book/search',
                method: 'POST',
                contentType: 'application/json',
                dataType: 'json',
                data: JSON.stringify(data),
                success: function(data) {
                    console.log("Books data received:", data);
                    $('#booksList').empty();
                    data.listResults.forEach(function(book) {
                        const bookCard = `
                            <div class="dz-shop-card style-2">
                                <div class="dz-media">
                                    <img alt="book" src="${book.bookCover}" onerror="this.src='../user/images/books/grid/book12.jpg';">
                                </div>
                                <div class="dz-content">
                                    <div class="dz-header">
                                        <div>
                                            <ul class="dz-tags">
                                                ${book.categories.map(category => `<li style="margin-left: 4px">${category}</li>`).join(', ')}
                                            </ul>
                                            <h4 class="title mb-0"><a href="/books/${book.isbn}">${book.title}</a></h4>
                                        </div>
                                        <div class="price">
                                            <span class="price-num text-primary">${book.point + " Point"}</span>
                                        </div>
                                    </div>

                                    <div class="dz-body">
                                        <div class="dz-rating-box">
                                            <div>
                                                <p class="dz-para" style="height: 110px; overflow: hidden; text-overflow: ellipsis">${book.description}</p>
                                                <div>
                                                    <span class="badge">${book.language}</span>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="rate">
                                            <ul class="book-info">
                                                <li><span>Written by</span> ${book.authors.join(', ')}</li>
                                                <li><span>Publication Date</span> ${formatDate(book.publicationDate)}</li>
                                            </ul>
                                            <div class="d-flex">
                                                <a class="btn btn-secondary btnhover btnhover2" href="/books/${book.isbn}"><i class="flaticon-shopping-cart-1 m-r10"></i>Read Now</a>
                                                <div class="bookmark-btn style-1">
                                                    <input class="form-check-input" id="flexCheckDefault${book.id}" type="checkbox" data-book-id="${book.id}">
                                                    <label class="form-check-label" for="flexCheckDefault${book.id}" data-book-id="${book.id}">
                                                        <i class="flaticon-heart" data-book-id="${book.id}"></i>
                                                    </label>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>`;
                        $('#booksList').append(bookCard);
                    });

                    // Pagination setup
                    $('#pagination').twbsPagination('destroy');
                    $('#pagination').twbsPagination({
                        totalPages:  data.totalPages === 0 ? 1 : data.totalPages,
                        startPage: data.currentPage,
                        visiblePages: limit,
                        first: 'First',
                        prev: '<<',
                        next: '>>',
                        last: 'Last',
                        onPageClick: function(event, page) {
                            if (page !== currentPage) {
                                currentPage = page;
                                loadBooks(page);
                            }
                        }
                    });

                    isLoading = false;
                },
                error: function(jqXHR, textStatus, errorThrown) {
                    console.error("Error loading books:", textStatus, errorThrown);
                    isLoading = false;
                },
                complete: function () {
                    // Hide the loading spinner
                    $('#loading-spinner').hide();
                }

            });
        }

        // Initial load of books
        loadBooks(1);

        $('#sBtn').on('click', function() {
            const minPoint = parseInt($('#minPoint').val());
            const maxPoint = parseInt($('#maxPoint').val());

            if (minPoint > maxPoint) {
                alert("Minimum point cannot be greater than maximum point!");
                return; // Stop further execution
            }
            loadBooks(1);
        });

        $('#refineBtn').on('click', function() {
            const minPoint = parseInt($('#minPoint').val());
            const maxPoint = parseInt($('#maxPoint').val());

            if (minPoint > maxPoint) {
                alert("Minimum point cannot be greater than maximum point!");
                return; // Stop further execution
            }
            loadBooks(1);
        });

        $(".filter-buttons button").click(function() {
            $("#minPoint").val("");
            $("#maxPoint").val("");

            $("#collapseOne input[type='checkbox']").prop("checked", false);

            $("#collapseThree input[type='checkbox']").prop("checked", false);
        });

        document.querySelectorAll('.form-check-label').forEach(function(icon) {
            icon.addEventListener('click', function(event) {
                if ( $('#accountId').length === 0) {
                    // Nếu chưa đăng nhập, hiển thị modal
                    $('#loginModal').modal('show');
                    return;
                }
                var bookId = event.target.getAttribute('data-book-id');
                var userConfirmed = window.confirm('Are you sure you want to add this book to favorites?');
                if (userConfirmed) {
                    addBookFromFavorites(bookId);
                }
            });
        });
    });



    function addBookFromFavorites(bookID) {
        sendAjaxRequest(`/api/favorites/add/${bookID}`, 'POST', null,
            function(response) { // Success callback
                toastr.success('Favorite added successfully', 'Success');
                // Optionally, update the UI to reflect the change
            },
            function(error) { // Error callback
                toastr.error('Book already exist in favorite list.', 'Error');
                console.error('Failed to add favorite', error);
                // Optionally, show an error message to the user
            }
        );
    }

    function sendAjaxRequest(url, method, data, successCallback, errorCallback) {
        $.ajax({
            url: url,
            method: method,
            data: data,
            success: successCallback,
            error: errorCallback
        });
    }
</script>
</body>
</html>